\subsection{Modelado}
\subsubsection{Obtener la función de transferencia de lazo abierto}

\paragraph{Impedancia de realimentación (paralelo $R_f \parallel C_f$).}
\begin{equation}
	Z_f \;=\; R_f \parallel \frac{1}{sC_f}
	\;=\; \frac{R_f\cdot \frac{1}{sC_f}}{R_f + \frac{1}{sC_f}}
	\;=\; \frac{R_f}{1 + s R_f C_f}.
	\label{eq:Zf}
\end{equation}

\paragraph{Esquema general del AO (entrada en $R_i$ al nodo inversor y referencia en la no inversora).}
Sea $V_{\text{ref}}$ la tensión aplicada a la entrada no inversora (por ejemplo, $V_{\text{ref}}=\text{VDDA}/2$ o $V_{\text{ref}}=\text{VDAC}$). Por superposición, el aporte total a la salida es la suma de:
\[
V_o \;=\; V_o\big|_{V_{\text{ref}}=0} \;+\; V_o\big|_{V_i=0}.
\]

\textbf{(A) Aporte de $V_i$ con $V_{\text{ref}}=0$ (no inversora a masa AC).}
Por cortocircuito virtual, $V_n=V_p=0$. Corrientes:
\[
i_1=\frac{V_i-0}{R_i}, \qquad i_2=\frac{0 - V_o}{Z_f}.
\]
KCL en el nodo inversor ($i_1=i_2$):
\[
\frac{V_i}{R_i}=\frac{-V_o}{Z_f}
\;\;\Rightarrow\;\;
\frac{V_o}{V_i}=-\frac{Z_f}{R_i}.
\]
Con \eqref{eq:Zf}:
\begin{equation}
	\frac{V_o}{V_i}\Bigg|_{V_{\text{ref}}=0}
	= -\,\frac{Z_f}{R_i}
	= -\,\frac{R_f}{R_i}\,\frac{1}{1+sR_f C_f}
	\label{eq:gain_inverting}
\end{equation}

\textbf{(B) Aporte de $V_{\text{ref}}$ con $V_i=0$ (entrada inversora a masa).}
Ahora $R_i$ va a masa y el AO queda en configuración no inversora con red $R_i$--$Z_f$ en la rama inversora. El lazo de realimentación fija:
\[
\frac{V_o - V_{\text{ref}}}{Z_f} = \frac{0 - V_{\text{ref}}}{R_i}
\;\;\Rightarrow\;\;
V_o = V_{\text{ref}}\!\left(1+\frac{Z_f}{R_i}\right).
\]
Con \eqref{eq:Zf}:
\begin{equation}
	\frac{V_o}{V_{\text{ref}}}\Bigg|_{V_i=0}
	= 1+\frac{Z_f}{R_i}
	= 1 + \frac{R_f}{R_i}\,\frac{1}{1+sR_f C_f}
	\label{eq:gain_noninv}
\end{equation}

\paragraph{Resultado por superposición (salida total).}
Sumando \eqref{eq:gain_inverting} y \eqref{eq:gain_noninv}:
\begin{equation}
	V_o(s)
	= \underbrace{\Bigg(-\frac{Z_f(s)}{R_i}\Bigg)}_{\text{camino inversor}}\,V_i(s)
	\;+\;
	\underbrace{\Bigg(1+\frac{Z_f(s)}{R_i}\Bigg)}_{\text{camino no inversor}}\,V_{\text{ref}}(s)
	\label{eq:superpos_total}
\end{equation}

\paragraph{Resultado de la Convolucion del Sistema.:}
Se realiza la convolucion para del resultado de la superposicion de los AO 1 y 2: 

\begin{equation}
	G_{o1}(s) = \frac{sR_1R_2C_1+2sR_2C_1+R_1}{R_1(sR_2C_1+1)}
	\label{eq:convolucion1_total}
\end{equation}

\begin{equation}
	G_{o2}(s) = \frac{sR_3R_4C_2+2sR_4C_2+R_3}{R_1(sR_4C_2+1)}
	\label{eq:convolucion2_total}
\end{equation}
Se realiza la convolucion de las ecuaciones \eqref{eq:convolucion1_total} y \eqref{eq:convolucion2_total}:
\begin{equation}
	G_{o1}(s)*G_{o2}(s) 
	\label{eq:convolucion_total}
\end{equation}

\onecolumn
\paragraph{Matlab} Se muestra el siguiente codigo de Matlab

\begin{lstlisting}[style=matlabstyle,caption={Script en Matlab},label={lst:mat}]
	
	%% Definicion de parametros
	R_1 = 15e3;
	R_3 = 15e3;
	C_2 = 100e-9;
	R_2 = 75e3;
	R_4 = 75e3;
	C_1 = 0.2e-6;
	%% Generar funcion de transferencia d
	numStage = [-R_3/R_1 -R_4/R_2];
	denStage = { [C_2*R_3 1], [C_1*R_4 1] };
	% Usamos celdas para guardar los tf de cada stage
	Gstage = cell(1,2);
	G = 1;
	for i = 1:2
	Gstage{i} = tf(numStage(i), denStage{i});
	G = G*Gstage{i};
	end
	%% Analizamos en el tiempo
	[tr, ts, wn] = plot_step_info(G);
	
	function [tr, ts, wn] = plot_step_info(G)
		info = stepinfo(G);
		tr = info.RiseTime;
		ts = info.SettlingTime;
		wn = 1.8 / tr;
		t_end = 1.1 * ts;
		if ~isfinite(t_end) || t_end <= 0, 
			t_end = 5 * max(tr, 1e-3); 
		end
		t = linspace(0, t_end, 2*pi/wn);
		[y, tout] = step(G, t);
		figure; plot(tout, y, 'LineWidth', 1.4); grid on; hold on;
		xlabel('Tiempo [s]'); ylabel('Salida');
		title(sprintf('Escalón: tr=%.4gs, ts=%.4gs, \\omega_n=%.4g rad/s', tr, ts, wn));
		xline(tr, '--', sprintf('  t_r=%.3g s', tr), 'LabelOrientation','horizontal');
		xline(ts,  ':', sprintf('  t_s=%.3g s', ts), 'LabelOrientation','horizontal');
		legend('G(t)', 'Location', 'best');
	end
	
\end{lstlisting}
\twocolumn

\paragraph{Notas prácticas.}
\begin{itemize}
	\item Si trabajás en pequeña señal respecto de $\text{VDDA}/2$, tomá $V_{\text{ref}}$ como la \emph{variación} alrededor de ese punto (es decir, $V_{\text{ref}}=0$ si la referencia es DC pura). En ese caso, el término de \eqref{eq:gain_noninv} desaparece y queda sólo el camino inversor \eqref{eq:gain_inverting}.
	\item Si la no inversora está a una referencia activa (p.ej.\ VDAC), \eqref{eq:superpos_total} te da el efecto simultáneo del estímulo $V_i$ y de esa referencia.
\end{itemize}

\paragraph{Encadenamiento de etapas (lazo abierto total).}
Si el AO3 es buffer ($G_3(s)=1$) y AO1, AO2 tienen cada uno la forma \eqref{eq:superpos_total}, entonces la función de lazo abierto (desde la \emph{señal de entrada} hasta la \emph{salida del último AO}, con $V_{\text{ref}}$ fijado según corresponda) es el producto de las ganancias de las etapas activadas por esa señal. Por ejemplo, si sólo excita $V_i$ y las no inversoras están a DC:
\[
G_{\text{ol}}(s)
= \Big(-\frac{Z_{f1}(s)}{R_{i1}}\Big)\,
\Big(-\frac{Z_{f2}(s)}{R_{i2}}\Big)\,
(1),
\quad
Z_{fk}(s)=\frac{R_{fk}}{1+sR_{fk}C_{fk}}.
\]
